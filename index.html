<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Asma's Vehicle Pro v6.4</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --primary: #1e3799; --bg: #f1f2f6; --danger: #eb4d4b; --warning: #f1c40f; --success: #2ecc71; --dark: #2f3542; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; overflow-x: hidden; width: 100%; }
        .header { background: linear-gradient(135deg, #1e3799, #0c2461); color: white; padding: 25px 15px 60px; text-align: center; }
        .summary-row { display: flex; gap: 8px; margin: -30px 10px 15px; }
        .sum-box { flex: 1; background: #fff; padding: 12px; border-radius: 12px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-top: 4px solid var(--primary); }
        .sum-box span { display: block; font-size: 10px; font-weight: bold; color: #666; margin-bottom: 2px; }
        .sum-box b { font-size: 15px; color: var(--dark); }
        .container { padding: 0 10px; }
        .form-card { background: white; padding: 15px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 25px; }
        input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1.5px solid #eee; border-radius: 10px; box-sizing: border-box; font-size: 14px; }
        .grid-3 { display: flex; gap: 5px; }
        .grid-3 input { flex: 1; min-width: 0; }
        .grid-dates { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        label { font-size: 10px; font-weight: bold; color: #666; margin-bottom: 3px; display: block; }
        .v-list-item { background: white; padding: 12px; border-radius: 15px; margin-bottom: 15px; border-left: 6px solid #ddd; display: flex; gap: 10px; position: relative; box-shadow: 0 3px 6px rgba(0,0,0,0.05); }
        .v-thumb { width: 65px; height: 65px; border-radius: 10px; object-fit: cover; background: #eee; flex-shrink: 0; }
        .dash-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; margin-top: 10px; }
        .dash-box { font-size: 8px; padding: 5px 2px; border-radius: 6px; text-align: center; font-weight: bold; background: #f8f9fa; border: 1px solid #eee; }
        .st-expired { background: #ff7675 !important; color: white !important; border-color: #d63031; }
        .st-due { background: #ffeaa7 !important; color: #856404 !important; border-color: #fdcb6e; }
        .bal-badge { position: absolute; top: 10px; right: 10px; font-size: 9px; font-weight: 900; padding: 4px 8px; border-radius: 15px; }
        .red-badge { background: #ffebeb; color: #d63031; border: 1px solid #feb2b2; }
        .green-badge { background: #e6fffa; color: #2ecc71; border: 1px solid #b2f5ea; }
        .btn-row { display: flex; gap: 5px; margin-top: 10px; flex-wrap: wrap; }
        .act-btn { flex: 1; min-width: 60px; border: none; padding: 10px 5px; border-radius: 8px; font-weight: bold; font-size: 9px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 4px; }
        #shareOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; overflow-y: auto; }
        .premium-card { background: white; width: 92%; max-width: 350px; border-radius: 20px; overflow: hidden; margin: 20px auto; text-align: center; }
        .ad-box { background: #f0f7ff; border: 1.5px solid #bee3f8; padding: 12px; border-radius: 15px; margin-top: 10px; }
        .dl-btn { background: #333; color: white; width: 92%; max-width: 350px; margin: 10px auto; display: block; padding: 15px; border-radius: 15px; font-weight: bold; border: none; }
    </style>
</head>
<body>

<div class="header"><h2>Asma's Vehicle Pro v6.4</h2></div>
<div class="summary-row">
    <div class="sum-box"><span>TOTAL PAID</span><b id="sumPaid">‚Çπ0</b></div>
    <div class="sum-box"><span>TOTAL BALANCE</span><b id="sumBal" style="color:var(--danger)">‚Çπ0</b></div>
</div>

<div class="container">
    <div class="form-card">
        <input type="hidden" id="editId">
        <div style="display:flex; gap:8px; margin-bottom:10px;">
            <button class="act-btn" style="background:#f1f2f6; border:1px solid #ddd;" onclick="document.getElementById('bgInp').click()">BANNER</button>
            <button class="act-btn" style="background:#f1f2f6; border:1px solid #ddd;" onclick="document.getElementById('vImgInp').click()">PHOTO</button>
            <input type="file" id="bgInp" hidden onchange="processImg(this, 'banner')">
            <input type="file" id="vImgInp" hidden onchange="processImg(this, 'vehicle')">
        </div>
        <input type="text" id="vNo" placeholder="Vehicle Number (eg: KL 10 AZ 1234)">
        <input type="text" id="oName" placeholder="Owner Name">
        <div class="grid-3">
            <input type="tel" id="oPhone" placeholder="Mobile">
            <input type="number" id="fee" placeholder="Fee">
            <input type="number" id="paid" placeholder="Paid">
        </div>
        <div class="grid-dates">
            <div><label>Insurance</label><input type="date" id="ins"></div>
            <div><label>Tax</label><input type="date" id="tax"></div>
            <div><label>Pollution</label><input type="date" id="pol"></div>
            <div><label>Fitness</label><input type="date" id="fit"></div>
            <div><label>Renewal</label><input type="date" id="ren"></div>
            <div><label>Welfare</label><input type="date" id="wel"></div>
        </div>
        <button class="act-btn" style="width:100%; margin-top:10px; background:var(--primary); color:white; padding:15px; font-size:12px;" onclick="saveData()">SAVE & UPDATE SUMMARY</button>
    </div>
    
    <input type="text" id="searchInput" placeholder="üîç Search vehicle or name..." onkeyup="loadData()" style="margin-bottom:15px; border:2px solid #ddd;">
    <div id="displayArea"></div>
</div>

<div id="shareOverlay">
    <button class="dl-btn" onclick="document.getElementById('shareOverlay').style.display='none'">CLOSE</button>
    <div id="card-to-capture" class="premium-card">
        <div style="background:var(--primary); color:white; padding:15px;"><div id="p_vNo" style="font-size:24px; font-weight:bold;"></div><div id="p_oName"></div></div>
        <div style="height:140px; position:relative; background:#222;"><img id="p_banner" style="width:100%; height:100%; object-fit:cover;"><img id="p_vimg" style="width:80px; height:80px; border:3px solid white; border-radius:50%; position:absolute; bottom:-40px; left:50%; transform:translateX(-50%); object-fit:cover; background:#fff;"></div>
        <div style="padding:50px 15px 15px;"><div id="p_alerts"></div>
            <div class="ad-box">
                <div style="color:var(--primary); font-weight:bold;">ASMA'S VEHICLE SERVICES</div>
                <div style="font-size:10px; color:#444;">‡¥é‡¥≤‡µç‡¥≤‡¥æ‡¥µ‡¥ø‡¥ß ‡¥µ‡µÜ‡¥π‡¥ø‡¥ï‡µç‡¥ï‡¥ø‡µæ ‡¥™‡µá‡¥™‡µç‡¥™‡µº ‡¥µ‡µº‡¥ï‡µç‡¥ï‡µÅ‡¥ï‡µæ‡¥ï‡µç‡¥ï‡µÅ‡¥Ç ‡¥µ‡¥ø‡¥≥‡¥ø‡¥ï‡µç‡¥ï‡µÇ.</div>
                <div style="font-size:18px; font-weight:900; color:#1a365d;">9037531655, 7012496868</div>
            </div>
        </div>
    </div>
    <button class="dl-btn" style="background:var(--success)" onclick="downloadCard()">SAVE TO GALLERY</button>
</div>

<script>
    let currentVImg = "";
    function processImg(i, t) {
        const r = new FileReader(); r.onload = (e) => { if(t==='banner') localStorage.setItem('asma_banner', e.target.result); else currentVImg = e.target.result; alert("Photo Updated!"); }; r.readAsDataURL(i.files[0]);
    }

    function getMinDiff(dates) {
        let diffs = [];
        for(let k in dates) { if(dates[k]) diffs.push(Math.ceil((new Date(dates[k]) - new Date().setHours(0,0,0,0)) / 86400000)); }
        return diffs.length ? Math.min(...diffs) : 9999;
    }

    function saveData() {
        const id = document.getElementById('editId').value;
        const v = {
            id: id ? parseInt(id) : Date.now(),
            vNo: document.getElementById('vNo').value.toUpperCase(),
            name: document.getElementById('oName').value,
            phone: document.getElementById('oPhone').value,
            fee: parseFloat(document.getElementById('fee').value || 0),
            paid: parseFloat(document.getElementById('paid').value || 0),
            vImg: currentVImg,
            dates: { "Insurance": document.getElementById('ins').value, "Tax": document.getElementById('tax').value, "Pollution": document.getElementById('pol').value, "Fitness": document.getElementById('fit').value, "Renewal": document.getElementById('ren').value, "Welfare": document.getElementById('wel').value }
        };
        let l = JSON.parse(localStorage.getItem('vData') || '[]');
        if(id) { 
            const i = l.findIndex(x => x.id === v.id); 
            if(!currentVImg) v.vImg = l[i].vImg; 
            l[i] = v; 
        } else {
            l.unshift(v);
        }
        localStorage.setItem('vData', JSON.stringify(l));
        location.reload(); 
    }

    function loadData() {
        let l = JSON.parse(localStorage.getItem('vData') || '[]');
        const searchTxt = document.getElementById('searchInput').value.toLowerCase();
        
        // ‡¥™‡¥£‡¥Ç ‡¥ï‡¥£‡¥ï‡µç‡¥ï‡¥æ‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ (Summary calculation)
        let totalPaid = 0;
        let totalBalance = 0;
        l.forEach(v => {
            totalPaid += (parseFloat(v.paid) || 0);
            totalBalance += ((parseFloat(v.fee) || 0) - (parseFloat(v.paid) || 0));
        });
        document.getElementById('sumPaid').innerText = "‚Çπ" + totalPaid.toLocaleString();
        document.getElementById('sumBal').innerText = "‚Çπ" + totalBalance.toLocaleString();

        // ‡¥§‡µÄ‡¥Ø‡¥§‡¥ø ‡¥Ö‡¥®‡µÅ‡¥∏‡¥∞‡¥ø‡¥ö‡µç‡¥ö‡µç ‡¥≤‡¥ø‡¥∏‡µç‡¥±‡µç‡¥±‡µç ‡¥Ö‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ (Sorting)
        l.sort((a, b) => getMinDiff(a.dates) - getMinDiff(b.dates));

        const area = document.getElementById('displayArea');
        area.innerHTML = '';

        l.forEach(v => {
            if(v.vNo.toLowerCase().includes(searchTxt) || v.name.toLowerCase().includes(searchTxt)) {
                const bal = (parseFloat(v.fee) || 0) - (parseFloat(v.paid) || 0);
                let dGrid = "";
                for(let k in v.dates) {
                    if(v.dates[k]) {
                        const diff = Math.ceil((new Date(v.dates[k]) - new Date().setHours(0,0,0,0)) / 86400000);
                        const cls = diff < 0 ? 'st-expired' : (diff <= 15 ? 'st-due' : '');
                        dGrid += `<div class="dash-box ${cls}">${k}<br>${v.dates[k].split('-').reverse().join('/')}</div>`;
                    }
                }

                area.innerHTML += `<div class="v-list-item">
                    <img src="${v.vImg || 'https://via.placeholder.com/65'}" class="v-thumb">
                    <div style="flex:1">
                        <div style="display:flex; justify-content:space-between">
                            <b style="font-size:14px;">${v.vNo}</b> 
                            ${bal > 0 ? `<span class="bal-badge red-badge">‚Çπ${bal}</span>` : `<span class="bal-badge green-badge">Paid ‚úÖ</span>`}
                        </div>
                        <div style="font-size:11px;color:grey">${v.name}</div>
                        <div class="dash-grid">${dGrid}</div>
                        <div class="btn-row">
                            <a href="tel:${v.phone}" class="act-btn" style="background:#3498db;color:white"><i class="fas fa-phone"></i> CALL</a>
                            <button class="act-btn wa-btn" onclick="sendWA(${v.id})"><i class="fab fa-whatsapp"></i> WhatsApp</button>
                            <button class="act-btn" style="background:var(--primary);color:white" onclick="showCard(${v.id})">CARD</button>
                            <i class="fas fa-edit" style="color:#aaa;padding:8px" onclick="editItem(${v.id})"></i>
                            <i class="fas fa-trash" style="color:#ddd;padding:8px" onclick="deleteItem(${v.id})"></i>
                        </div>
                    </div>
                </div>`;
            }
        });
    }

    function sendWA(id) {
        const v = JSON.parse(localStorage.getItem('vData')).find(x => x.id === id);
        const b = (parseFloat(v.fee) || 0) - (parseFloat(v.paid) || 0);
        let m = `*ASMA'S VEHICLE SERVICES*\n--------------------------\n‡¥™‡µç‡¥∞‡¥ø‡¥Ø‡¥™‡µç‡¥™‡µÜ‡¥ü‡µç‡¥ü ${v.name},\n‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ${v.vNo} ‡¥µ‡¥æ‡¥π‡¥®‡¥§‡µç‡¥§‡¥ø‡¥®‡µç‡¥±‡µÜ ‡¥§‡¥æ‡¥¥‡µÜ ‡¥™‡¥±‡¥Ø‡µÅ‡¥®‡µç‡¥® ‡¥™‡µá‡¥™‡µç‡¥™‡¥±‡µÅ‡¥ï‡µæ ‡¥™‡µÅ‡¥§‡µÅ‡¥ï‡µç‡¥ï‡µá‡¥£‡µç‡¥ü ‡¥∏‡¥Æ‡¥Ø‡¥Ç ‡¥ï‡¥¥‡¥ø‡¥û‡µç‡¥û‡¥ø‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ:\n`;
        for(let k in v.dates) { 
            const d = Math.ceil((new Date(v.dates[k]) - new Date().setHours(0,0,0,0)) / 86400000);
            if(d <= 30) m += `\n‚ö†Ô∏è *${k}*: ${v.dates[k].split('-').reverse().join('/')}`;
        }
        if(b > 0) m += `\n\nüí∞ *‡¥¨‡¥æ‡¥ï‡µç‡¥ï‡¥ø ‡¥§‡µÅ‡¥ï: ‚Çπ${b}*`;
        m += `\n\n--------------------------\n*‡¥µ‡µÜ‡¥π‡¥ø‡¥ï‡µç‡¥ï‡¥ø‡µæ ‡¥∏‡¥Ç‡¥¨‡¥®‡µç‡¥ß‡¥Æ‡¥æ‡¥Ø ‡¥é‡¥≤‡µç‡¥≤‡¥æ ‡¥™‡µá‡¥™‡µç‡¥™‡µº ‡¥µ‡µº‡¥ï‡µç‡¥ï‡µÅ‡¥ï‡µæ‡¥ï‡µç‡¥ï‡µÅ‡¥Ç ‡¥µ‡¥ø‡¥≥‡¥ø‡¥ï‡µç‡¥ï‡µÇ:*\nüìû 9037531655, 7012496868`;
        window.open(`https://wa.me/${v.phone}?text=${encodeURIComponent(m)}`);
    }

    function deleteItem(id) {
        if(confirm("‡¥à ‡¥µ‡¥£‡µç‡¥ü‡¥ø ‡¥≤‡¥ø‡¥∏‡µç‡¥±‡µç‡¥±‡¥ø‡µΩ ‡¥®‡¥ø‡¥®‡µç‡¥®‡µç ‡¥®‡µÄ‡¥ï‡µç‡¥ï‡¥Ç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥ü‡µç‡¥ü‡µÜ?")) {
            let l = JSON.parse(localStorage.getItem('vData') || '[]');
            l = l.filter(x => x.id !== id);
            localStorage.setItem('vData', JSON.stringify(l));
            loadData();
        }
    }

    function showCard(id) {
        const v = JSON.parse(localStorage.getItem('vData')).find(x => x.id === id);
        document.getElementById('p_vNo').innerText = v.vNo; 
        document.getElementById('p_oName').innerText = v.name;
        document.getElementById('p_banner').src = localStorage.getItem('asma_banner') || "";
        document.getElementById('p_vimg').src = v.vImg || "https://via.placeholder.com/90";
        document.getElementById('p_alerts').innerHTML = "";
        for(let k in v.dates) {
            if(v.dates[k]) {
                const d = Math.ceil((new Date(v.dates[k]) - new Date().setHours(0,0,0,0)) / 86400000);
                if(d <= 30) document.getElementById('p_alerts').innerHTML += `<div style="font-size:12px; font-weight:bold; color:red; margin-bottom:4px;">‚ö†Ô∏è ${k} ${d < 0 ? '‡¥§‡µÄ‡µº‡¥®‡µç‡¥®‡µÅ' : d + ' ‡¥¶‡¥ø‡¥µ‡¥∏‡¥§‡µç‡¥§‡¥ø‡¥®‡µÅ‡¥≥‡µç‡¥≥‡¥ø‡µΩ ‡¥§‡µÄ‡¥∞‡µÅ‡¥Ç'}</div>`;
            }
        }
        document.getElementById('shareOverlay').style.display = 'block';
    }

    function downloadCard() {
        html2canvas(document.querySelector("#card-to-capture"), { useCORS: true, scale: 2 }).then(c => {
            const l = document.createElement('a'); l.download = 'Asma_Card.png'; l.href = c.toDataURL(); l.click();
        });
    }

    function editItem(id) {
        const v = JSON.parse(localStorage.getItem('vData')).find(x => x.id === id);
        document.getElementById('editId').value = v.id;
        document.getElementById('vNo').value = v.vNo; 
        document.getElementById('oName').value = v.name;
        document.getElementById('oPhone').value = v.phone; 
        document.getElementById('fee').value = v.fee;
        document.getElementById('paid').value = v.paid;
        document.getElementById('ins').value = v.dates["Insurance"]; 
        document.getElementById('tax').value = v.dates["Tax"];
        document.getElementById('pol').value = v.dates["Pollution"]; 
        document.getElementById('fit').value = v.dates["Fitness"];
        document.getElementById('ren').value = v.dates["Renewal"]; 
        document.getElementById('wel').value = v.dates["Welfare"];
        currentVImg = v.vImg; 
        window.scrollTo(0,0);
    }
    document.addEventListener('DOMContentLoaded', loadData);
</script>
</body>
</html>
